<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CardForge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
    </style>
</head>

<body class="bg-gray-900 text-white">
    <div id="root"></div>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        // --- Authentication Context (No changes) ---
        const AuthContext = createContext(null);
        const AuthProvider = ({ children }) => {
            const [token, setToken] = useState(() => localStorage.getItem('authToken'));

            useEffect(() => {
                if (token) {
                    localStorage.setItem('authToken', token);
                } else {
                    localStorage.removeItem('authToken');
                }
            }, [token]);

            const logout = () => setToken(null);

            const apiFetch = async (endpoint, options = {}) => {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers,
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const response = await fetch(endpoint, { ...options, headers });
                if (response.status === 401) {
                    logout();
                    throw new Error('Unauthorized');
                }
                return response;
            };

            return (
                <AuthContext.Provider value={{ token, setToken, logout, apiFetch }}>
                    {children}
                </AuthContext.Provider>
            );
        };
        const useAuth = () => useContext(AuthContext);

        // --- Main App Components (No changes) ---
        function App() {
            const { token } = useAuth();
            return token ? <MainPage /> : <LoginPage />;
        }

        function LoginPage() {
            // ... (This component remains the same)
            const [isLoginView, setIsLoginView] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [message, setMessage] = useState({ text: '', isError: false });
            const [isLoading, setIsLoading] = useState(false);
            const { setToken } = useAuth();
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setMessage({ text: '', isError: false });
                const endpoint = isLoginView ? '/api/login' : '/api/register';
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password }),
                    });
                    const data = await response.json();
                    if (data.success) {
                        if (isLoginView && data.token) {
                            setToken(data.token);
                        } else {
                            setMessage({ text: data.message, isError: false });
                            setIsLoginView(true);
                            setPassword('');
                        }
                    } else {
                        setMessage({ text: data.message || 'An error occurred.', isError: true });
                    }
                } catch {
                    setMessage({ text: 'Server error. Try again later.', isError: true });
                } finally {
                    setIsLoading(false);
                }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 p-4">
                    <div className="max-w-md w-full bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700">
                        <h2 className="text-3xl font-bold text-center text-white mb-2">
                            {isLoginView ? 'Welcome Back' : 'Create Account'}
                        </h2>
                        <p className="text-center text-gray-400 mb-8">
                            {isLoginView ? 'Sign in to continue to CardForge' : 'Get started with a new account'}
                        </p>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label htmlFor="email" className="block text-gray-300 text-sm font-bold mb-2">Email</label>
                                <input type="email" id="email" required className="w-full px-3 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-500" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div className="mb-6">
                                <label htmlFor="password" className="block text-gray-300 text-sm font-bold mb-2">Password</label>
                                <input type="password" id="password" required className="w-full px-3 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-500" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            {message.text && (
                                <div className={`p-3 mb-4 rounded-md text-center text-sm ${message.isError ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}`}>
                                    {message.text}
                                </div>
                            )}
                            <div className="flex flex-col gap-4">
                                <button type="submit" disabled={isLoading} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center disabled:opacity-50">
                                    {isLoading && <span className="mr-2 animate-spin">‚è≥</span>}
                                    {isLoading ? 'Processing...' : isLoginView ? 'Sign In' : 'Create Account'}
                                </button>
                                <button type="button" onClick={() => setIsLoginView(!isLoginView)} className="w-full text-indigo-400 hover:text-indigo-300 text-sm font-medium">
                                    {isLoginView ? "Don't have an account? Sign up" : 'Already have an account? Sign in'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- UPDATED: MainPage Component ---
        function MainPage() {
            const [activeTab, setActiveTab] = useState('Store');
            const { logout } = useAuth();
            const menuItems = [
                { id: 'Inventory', icon: 'üì¶', name: 'Inventory' },
                { id: 'Store', icon: 'üõí', name: 'Store' },
                { id: 'Friends', icon: 'üë•', name: 'Friends' },
                { id: 'Chat', icon: 'üí¨', name: 'Chat' },
                { id: 'Connect Discord', icon: 'üîó', name: 'Connect Discord' },
                { id: 'Leaderboard', icon: 'üèÜ', name: 'Leaderboard' },
            ];

            const renderContent = () => {
                switch (activeTab) {
                    case 'Store': return <StoreContent />;
                    // --- NEW: Render InventoryContent component ---
                    case 'Inventory': return <InventoryContent />;
                    default: return <PlaceholderContent title={activeTab} />;
                }
            };

            return (
                <div className="flex h-screen bg-gray-900">
                    <nav className="w-64 bg-gray-800 p-4 flex flex-col justify-between border-r border-gray-700">
                        <div>
                            <div className="text-2xl font-bold text-white mb-10 px-2">CardForge</div>
                            <ul className="space-y-2">
                                {menuItems.map(item => (
                                    <li key={item.id}>
                                        <a href="#" onClick={e => { e.preventDefault(); setActiveTab(item.id); }}
                                            className={`flex items-center p-3 text-sm font-medium rounded-lg transition-colors ${activeTab === item.id ? 'bg-indigo-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                                }`}>
                                            <span className="w-5 h-5 mr-3">{item.icon}</span>
                                            {item.name}
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        </div>
                        <button onClick={logout} className="flex items-center p-3 w-full text-sm font-medium rounded-lg text-red-400 hover:bg-red-900/50 hover:text-red-300 transition-colors">
                            <span className="w-5 h-5 mr-3">üö™</span>
                            Log Out
                        </button>
                    </nav>
                    <main className="flex-1 overflow-y-auto">{renderContent()}</main>
                </div>
            );
        }

        // --- Store Content Component (No changes) ---
        function StoreContent() {
            // ... (This component remains the same)
            const [packResult, setPackResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const { apiFetch } = useAuth();
            const handleOpenPack = async () => {
                setIsLoading(true);
                setError(null);
                setPackResult(null);
                try {
                    const res = await apiFetch('/api/open_pack', { method: 'POST' });
                    const data = await res.json();
                    if (res.ok && data.success) {
                        setPackResult(data);
                    } else {
                        setError(data.message || 'Failed to open pack.');
                    }
                } catch {
                    setError('An error occurred while communicating with the server.');
                } finally {
                    setIsLoading(false);
                }
            };
            return (
                <div className="p-8">
                    <h1 className="text-3xl font-bold">Store</h1>
                    <p className="text-gray-400 mt-2 mb-8">Purchase and open card packs to build your collection.</p>
                    <div className="bg-gray-800 p-6 rounded-lg max-w-sm border border-gray-700">
                        <h2 className="text-xl font-semibold">Standard Pack</h2>
                        <p className="text-gray-400 mt-1">Contains 5 random cards.</p>
                        <button onClick={handleOpenPack} disabled={isLoading}
                            className="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center disabled:opacity-50">
                            {isLoading && <span className="mr-2 animate-spin">üé≤</span>}
                            {isLoading ? 'Opening...' : 'Open Pack'}
                        </button>
                    </div>
                    {error && <div className="mt-6 p-4 rounded-md bg-red-900/50 text-red-300 max-w-sm">{error}</div>}
                    {packResult?.success && (
                        <div className="mt-6 max-w-sm">
                            <h3 className="text-lg font-semibold mb-2">{packResult.message}</h3>
                            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                {packResult.cards.map((card, index) => (
                                    <div key={index} className="flex justify-between items-center p-2 border-b border-gray-700 last:border-b-0">
                                        <span className="text-gray-300">{card.name}</span>
                                        <span className="text-indigo-400 font-mono"># {card.number}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- NEW: Inventory Content Component ---
        function InventoryContent() {
            const [inventory, setInventory] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const { apiFetch } = useAuth();

            useEffect(() => {
                const fetchInventory = async () => {
                    try {
                        const res = await apiFetch('/api/inventory'); // Uses GET by default
                        const data = await res.json();
                        if (res.ok && data.success) {
                            setInventory(data.inventory);
                        } else {
                            setError(data.message || 'Failed to fetch inventory.');
                        }
                    } catch {
                        setError('Could not connect to the server.');
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchInventory();
            }, []); // Empty dependency array means this runs once on mount

            return (
                <div className="p-8">
                    <h1 className="text-3xl font-bold">My Inventory</h1>
                    <p className="text-gray-400 mt-2 mb-8">All of the cards you've collected.</p>

                    {isLoading && <p>Loading your collection...</p>}
                    {error && <div className="p-4 rounded-md bg-red-900/50 text-red-300 max-w-md">{error}</div>}

                    {!isLoading && !error && (
                        inventory.length > 0 ? (
                            <div className="card-grid">
                                {inventory.map((card, index) => (
                                    <div key={index} className="bg-gray-800 border border-gray-700 rounded-lg p-4 flex flex-col justify-between">
                                        <h3 className="font-bold text-lg text-white">{card.name}</h3>
                                        <p className="text-sm text-indigo-400 font-mono mt-2"># {card.number}</p>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p>Your inventory is empty. Open a pack in the store to get started!</p>
                        )
                    )}
                </div>
            );
        }

        // --- Placeholder Component (No changes) ---
        function PlaceholderContent({ title }) {
            return (
                <div className="p-8">
                    <h1 className="text-3xl font-bold">{title}</h1>
                    <p className="text-gray-400 mt-2">This section is under construction. Check back soon!</p>
                </div>
            );
        }

        // --- Main Render Call (No changes) ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(
            <AuthProvider>
                <App />
            </AuthProvider>
        );
    </script>
</body>

</html>